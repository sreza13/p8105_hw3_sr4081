---
title: "HW3_Markdown"
author: "Samiha Reza"
date: "2024-10-14"
output:
  md_document: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 6,
  fig.asp = .6,
  out.width = "90%", 
  echo = TRUE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggridges)
library(patchwork)
library(p8105.datasets)
library(readxl)
library(patchwork)
data("ny_noaa")
janitor::clean_names(ny_noaa)
```

## Problem 1
### Data Summary and Data Manipulation

Below is the data summary for the ny_noaa dataset: 

``` {r data exploration, echo = FALSE}
summary(ny_noaa)
str(ny_noaa)
```
The dataset consists of `r nrow(ny_noaa)- 1` observations and `r ncol(ny_noaa)` variables. Key variables include `r names(ny_noaa)` of which `r sum(sapply(ny_noaa, is.numeric))` are numeric, `r sum(sapply(ny_noaa, is.character))` are character. There is one date variable.

The units for the listed variables are: 
`id`: Weather station ID
`date`: Date of observation
`prcp`: Precipitation (tenths of mm)
`snow`: Snowfall (mm)
`snwd`: Snow depth (mm)
`tmax`: Maximum temperature (tenths of degrees C)
`tmin`: Minimum temperature (tenths of degrees C)

There are `r sum(is.na(ny_noaa))` missing values. 

Below is a table of the number of missing values for each variable, and the proportion of each variable that is missing data. 43.7% of the tmax and tmin data is missing. 

``` {r na_missing, echo = FALSE}
colSums(is.na(ny_noaa))
colMeans(is.na(ny_noaa))
```


``` {r tidydata}
ny_noaa$date <- as.Date(ny_noaa$date) 

ny_noaa <- ny_noaa %>% #seperate date into different variables
  mutate(year = year(date),
         month = month(date),
         day = day(date)) %>%
    

  mutate(prcp = as.numeric(prcp) / 10, #mutate variables to be more managemable units
    tmax = as.numeric(tmax) / 10, 
    tmin = as.numeric(tmin) / 10,
    snwd = as.numeric(snwd) / 10)

```
### Snowfall observations
Below is the code chunk and table to determine the most commonly observed values of snowfall. 
The most common snowfall value is 0 mm because most days of the year don't have snow. The second most comman finding is NA, because of the high proprotion of missing data.

``` {r}
ny_noaa %>%
  count(snow) %>%
  arrange(desc(n)) %>%
  head(5)

```

 

### Plots


``` {r plot}

jan_jul_subset <- ny_noaa %>%
  filter(month %in% c(1, 7)) %>%  # Filter for January (1) and July (7)
  group_by(id, year, month) %>%   # Group by id, year, and month
  summarize(avg_tmax = mean(tmax, na.rm = TRUE), .groups = 'drop') # Calculate average temperature

# Create the ggplot
ggplot(data = jan_jul_subset, aes(x = year, y = avg_tmax, group = id)) + 
  geom_point() + 
  geom_path() +
  facet_grid(~month) +  # Separate panels for each month
  labs(title = "Mean Monthly Temperature for Each Station Across Years for January and July") +
  theme_minimal()

```
``` {r hex}
hex = 
  ny_noaa %>% 
  ggplot(aes(x = tmin, y = tmax)) + 
  geom_hex()

ridge = 
  ny_noaa %>% 
  filter(snow < 100, snow > 0) %>%
  ggplot(aes(x = snow, y = as.factor(year))) + 
  geom_density_ridges()


hex_png + ridge_png


```
getwd()

## Problem 2
### Problem 2 Data

``` {r problem_2_data, message = FALSE}
library(readr)
nhanes_accel = 
  read_csv("./nhanes_accel.csv",
  na = c("NA", ",", "")) %>%
  janitor::clean_names()

nhanes_covar = 
  read_csv("./nhanes_covar.csv", 
           na = c("NA", ",", ""),
           skip = 4) %>%
  janitor::clean_names()%>%
  
  mutate(
    sex = factor(sex),
    education = factor(education),
    sex = case_when(
      sex == 1 ~ "male", 
      sex == 2 ~ "female"
    ),

    education = case_when(
      education == 1 ~ "less than high school", 
      education == 2 ~ "high school equivalent", 
      education == 3 ~ "more than high school"
    )
)

#Exclude participants less than 21 years of age, and those with missing demographic data
nhanes_mims = 
  full_join(nhanes_covar, nhanes_accel)%>%
  filter(!is.na(education) & age >= 21) 


```

Here we cleaned, tidied, and joined the data sets while mutating sex and education into factor variables. The dataset consists of `r nrow(nhanes_mims)- 1` observations and `r ncol(nhanes_mims)` variables.

### Sex and Education Table

Here we have table of number of female and male particpants in each of the education categories: high school, less than high school and more then high school. There are more female and male participants that have had more than high school. Less than high school is also comparable between the two groups but there are more males with high school equivalent than females. 

``` {r table_mf }

nhanes_mims %>%
  group_by(education, sex)%>%
  janitor::tabyl(sex, education)

```

### Age Distribution 

This three-panel density plot looks at the distribution of age for each gender, seperated by education type. The males with high school equivalent tend to be younger than females. Less than high school age distrbution between the two sexes is similar, with slightly more young males. Finally, There are substantially more young females with more than high school education. 

``` {r age_distrb}

age_distrb = 
  ggplot(nhanes_mims, aes(x = age, fill = sex)) +
  geom_density(alpha = 0.5) + 
  facet_grid( ~ education) +
  labs(title = "Age Distribution by Gender and Education",
       x = "Age", y = "Count", fill = "Sex") +
  scale_fill_manual(values = c( "red", "blue")) +

  theme_minimal()


```

### Total Activity 

The three-panel scatter plot seperates data by education level and looks at differences of total activity by age for each sex. All three education levels show a decrease in total activity over time, but this decrease is much sharper in the less than high school education group. Females also tended to have higher total activity regardless of education or age, except for older females with less than high school education. 

``` {r total_activity }

nhanes_mims <- nhanes_mims %>%
  mutate(total_mims = rowSums(across(min1:min1440), na.rm = TRUE))

totalactivity = ggplot(data = nhanes_mims, aes(x = age, y = total_mims, color = sex)) + 
  geom_point() +  
  geom_smooth(se = FALSE) +
  facet_wrap(~ education) +  
  labs(
    title = "Total Activity by Age and Education Level",
    color = "Sex",
    x = "Age",
    y = "Total MIMS"
  ) +
  theme_minimal()  

```

### 24-Hour Cycle Plots

The 3-panel plot looks at how mean total energy fluctuates over time for the different education groups between men and women. Men and women with less than high school education both peak in total energy earlier and more than the other education groups. Total energy for this group also drops off consistently after this peak early in the day. For the other two groups, the total energy tends to plateau over the course of the day.

```{r 24_cycle, message = FALSE}
nhanes_data_df <- nhanes_mims %>%
  pivot_longer(
    cols = min1:min1440,
    names_to = "minute",
    values_to = "MIMS",
    names_prefix = "min") %>%
  group_by(seqn, sex, age, education) 

nhanes_avg <- nhanes_data_df %>%
  group_by(minute, sex, education) %>%  # Group by sex and minute
  summarize(mean_MIMS = mean(MIMS, na.rm = TRUE))


# Plot total activity against minutes, with facets by education level and seperated by sex
hr_cycle = ggplot(nhanes_avg, aes(x = as.numeric(minute), y = mean_MIMS, color = sex)) + 
  geom_line() +
  facet_grid(. ~ education) +  # Separate panels for education levels
  labs(
    title = "Mean MIMS 24-Hr Cycle by Sex and Education Level",
    x = "Minute of the Day",
    y = "Mean MIMS",
    caption = "NHANES data of participants aged 21 and over"
  ) +
  theme_minimal()  
```

## Problem 3

### Problem 3 Data Tidying

``` {r data, message = FALSE}

Jan_2020_bike <- read_csv("./citibike/Jan 2020 Citi.csv", na = c("NA", ".", "")) %>%
  janitor::clean_names()%>%
  mutate(year = 2020, month = "January")

Jan_2024_bike <- read_csv("./citibike/Jan 2024 Citi.csv", na = c("NA", ".", "")) %>%
  janitor::clean_names()%>%
  mutate(year = 2024, month = "January")

July_2020_bike <- read_csv("./citibike/July 2020 Citi.csv", na = c("NA", ".", "")) %>%
  janitor::clean_names()%>%
  mutate(year = 2020, month = "July")

July_2024_bike <- read_csv("./citibike/July 2024 Citi.csv", na = c("NA", ".", "")) %>%
  janitor::clean_names()%>%
  mutate(year = 2024, month = "July")

citi_bike_data <- bind_rows(Jan_2020_bike, Jan_2024_bike, July_2020_bike, July_2024_bike)
glimpse(citi_bike_data)
```

Here we loaded, tidied, and merged the four csv files.  The new dataset consists of `r nrow(citi_bike_data)- 1` observations and `r ncol(citi_bike_data)` variables.

### Number of Biker Types per Year and Month

There are more bikers in July 2024 than in any other month and year. There tend to be less casual bikers during January months compared to July. Member bikers have increased over time, with the largest spike between January 2024 and July 2024. 

```{r summary table}
rides_summary <- citi_bike_data %>%
  group_by(year, month, member_casual) %>%
  summarize(total_rides = n(), .groups = 'drop')
  
rides_pivot <- rides_summary %>%
  pivot_wider(names_from = member_casual, values_from = total_rides, values_fill = 0) %>%
  arrange(year, month)
  
print(rides_pivot)
```

### Top Stations

```{r top stations}

top_stations <- citi_bike_data %>%
  filter(month == "July", year == 2024) %>%
  group_by(start_station_name) %>%
  summarize (num_rides = n()) %>%
  arrange(desc(num_rides)) %>%
  slice_head (n = 5)
  
print(top_stations)
```

The top five stations are `r top_stations$start_station_name`. 
### Median Ride Duration Plots

These are three plots that look at median ride duration for three different variables of interest, month, year, and day of the week. Median duration is higher in July than in January, higher in 2020 than in 2024, and peaks during the weekend.
``` {r, message = FALSE}

median_ride_duration <- citi_bike_data %>%
  group_by(weekdays, month, year) %>%
  summarize(median_duration = median(duration, na.rm = TRUE))

month_p = 
ggplot(median_ride_duration, aes(x = month, y = median_duration)) +
  geom_bar(stat = "identity", fill = "steelblue") + # Use a bar chart
  labs(
    title = "Median Duration by Month",
    x = "Month",
    y = "Median Duration (minutes)"
  ) +
  theme(axis.text.x = element_text(size = 5),
                plot.title = element_text(size = 10))

weekday_p =
ggplot(median_ride_duration, aes(x = weekdays, y = median_duration)) +
  geom_bar(stat = "identity", fill = "steelblue") + # Use a bar chart
  labs(
    title = "Median Duration by Weekday",
    x = "Weekdays",
    y = "Median Duration (minutes)"
  ) +
  theme(axis.text.x = element_text(size = 5),
                plot.title = element_text(size = 10))
year_p = 
ggplot(median_ride_duration, aes(x = year, y = median_duration)) +
  geom_bar(stat = "identity", fill = "steelblue") + # Use a bar chart
  labs(
    title = "Median Duration by Year",
    x = "Year",
    y = "Median Duration (minutes)"
  ) +
  theme(axis.text.x = element_text(size = 5),
                plot.title = element_text(size = 10))
(month_p + weekday_p/year_p)
``` 
### Impact of Month, Membership, and Bike Type on Ride Duration

Here is a faceted grid plot where membership type is listed on top and the month on the side by bike type. Being a member decreases the ride duration for all variables (month and bike type). For casual bikers, electric bikes tended to have shorter ride durations. These conclusions are determined by looking at how many minutes the highest density of bikers in that category fall. 

``` {r, message = FALSE}
bike_data_2024 <- citi_bike_data %>%
  filter(year == "2024")

ride_type = ggplot(bike_data_2024, aes(x = duration, fill = rideable_type)) +
  geom_density(alpha = 0.2) +   # Density plot to show distribution
  facet_grid(month ~ member_casual) +  # Separate panels for month and membership
  labs(
    title = "Impact of Month, Membership Status, and Bike Type on Ride Duration",
    x = "Ride Duration (minutes)",
    y = "Density",
    fill = "Bike Type"
  ) +
  theme_minimal()

```

